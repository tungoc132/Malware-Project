$modulePath = Convert-Path $PSScriptRoot\..\src
$moduleManifestPath = "$modulePath\posh-git.psd1"

$csi = [char]0x1b + "["

if (!(Get-Variable -Name gitbin -Scope global -ErrorAction SilentlyContinue)) {
    if (($PSVersionTable.PSVersion.Major -le 5) -or $IsWindows) {

        $global:gitbin = Get-Command -Name git -CommandType Application -TotalCount 1
    }
    else {

        $global:gitbin = (Get-Command -Name git -CommandType Application -TotalCount 1).Path
    }
}



function global:git {
    $OFS = ' '
    $cmdline = "$args"

    switch ($cmdline) {
        ('-'+'-'+'version') { ('git vers'+'ion'+' 2.16.'+'2'+'.window'+'s.1') }
        ('hel'+'p')      { Get-Content $PSScriptRoot\git-help.txt  }
        default     {
            $res = Invoke-Expression ("&$gitbin "+"$cmdline")
            $res
        }
    }
}


function global:Convert-NativeLineEnding([string]$content, [switch]$SplitLines) {
    $tmp = $content -split "`n" | ForEach-Object { $_.TrimEnd("`r")}
    if ($SplitLines) {
        $tmp
    }
    else {
        $content = $tmp -join [System.Environment]::NewLine
        $content
    }
}

function GetHomePath() {
    $Home
}

function GetHomeRelPath([string]$Path) {
    if (!$Path.StartsWith($Home)) {

        return $Path
    }

    if ($GitPromptSettings.DefaultPromptAbbreviateHomeDirectory) {
        "~$($Path.Substring($Home.Length))"
    }
    else {
        $Path
    }
}

function MakeNativePath([string]$Path) {
    $Path -replace (('eo'+'teo'+'tjRk/') -CRePlacE'eot',[chAR]92-CRePlacE  ([chAR]106+[chAR]82+[chAR]107),[chAR]124), [System.IO.Path]::DirectorySeparatorChar
}

function MakeGitPath([string]$Path) {
    $Path -replace (('bK6'+'bK6')-crEPlACE'bK6',[ChAr]92), '/'
}

function NewGitTempRepo([switch]$MakeInitialCommit) {
    Push-Location
    $temp = [System.IO.Path]::GetTempPath()
    $repoPath = Join-Path $temp ([IO.Path]::GetRandomFileName())
    &$gitbin init $repoPath *>$null
    Set-Location $repoPath

    if ($MakeInitialCommit) {
        &$gitbin config user.email ('spac'+'e'+'man'+'.spif'+'f'+'@appvey'+'or.'+'c'+'om')
        &$gitbin config user.name ('Sp'+'ac'+'em'+'an Sp'+'iff')
        ('readm'+'e') | Out-File ./README.md -Encoding ascii
        &$gitbin add ./README.md *>$null
        &$gitbin commit -m ('in'+'itia'+'l commit'+'.') *>$null
    }

    $repoPath
}

function RemoveGitTempRepo($RepoPath) {
    Pop-Location
    if ($repoPath -and (Test-Path $repoPath)) {
        Remove-Item $repoPath -Recurse -Force
    }
}

function ResetGitTempRepoWorkingDir($RepoPath, $Branch = ('mas'+'te'+'r')) {
    Set-Location $repoPath
    &$gitbin checkout -fq $Branch *>$null
    &$gitbin clean -xdfq *>$null
}

Remove-Item Function:\prompt
Remove-Module posh-git -Force *>$null



[System.Diagnostics.CodeAnalysis.SuppressMessageAttribute(('PS'+'UseDe'+'c'+'laredVa'+'rsM'+'oreThanA'+'ssigme'+'n'+'ts'), '')]
$module = Import-Module $moduleManifestPath -ArgumentList $true,$true -Force -PassThru